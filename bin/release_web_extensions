#!/usr/bin/env bash

set +o errexit

function check_branch_is_master {
    BRANCH_NAME=$(git branch | grep \* | cut -d ' ' -f2)
    if [ $BRANCH_NAME != "master" ]
    then
        echo >&2 "Current branch is not master. Aborting."
        exit 1
    fi
}

function check_tag_is_present {
    git describe --exact-match --tags
    if [ $? != 0 ]
    then
        echo >&2 "Current revision is not tagged. Aborting."
        exit 1
    fi
}

function check_repository_is_clean {
    git remote update
    git status
    git diff-index --quiet HEAD --;
    if [ $? == 1 ]
    then
        echo >&2 "Git repository not clean. Aborting."
        exit 1
    fi
}

function check_env_variables_setted {
    if [ -z "$EXTENSION_ID" ] || [ -z "$CLIENT_ID" ] || [ -z "$CLIENT_SECRET" ] || [ -z "$REFRESH_TOKEN" ] || [ -z "$WEB_EXT_API_KEY" ] || [ -z "$WEB_EXT_API_SECRET" ]; then
        echo "Need to set EXTENSION_ID, CLIENT_ID, CLIENT_SECRET, REFRESH_TOKEN, WEB_EXT_API_KEY and WEB_EXT_API_SECRET env variables to release web extensions"
        exit 1
    fi
}

check_branch_is_master
check_tag_is_present
check_env_variables_setted
yarn workspace lesspass-web-extension run build
yarn workspace lesspass-pure run build
check_repository_is_clean

set -o errexit
set -o pipefail
set -o nounset

yarn workspace lesspass-web-extension run release
VERSION=$(grep -Po '(?<="version": ")[^"]*' package.json)
echo "See the new release on https://github.com/lesspass/lesspass/releases/tag/${VERSION}"
